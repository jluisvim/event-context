name: Daily News Analysis

on:
  schedule:
    - cron: '0 9 * * *'  # Ejecuta a las 9 AM UTC todos los dÃ­as
  workflow_dispatch:     # Permite ejecuciÃ³n manual

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      # 1. Clona el repositorio (con submÃ³dulos)
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: recursive  # â† Clona themes/terminal si es submÃ³dulo

      # 2. Verifica que la carpeta blog/ existe
      - name: Check blog directory
        run: |
          if [ ! -d "blog" ]; then
            echo "âŒ Error: La carpeta 'blog/' no existe en el repositorio."
            echo "AsegÃºrate de hacer 'git add blog' y 'git push'."
            exit 1
          else
            echo "âœ… Carpeta 'blog/' encontrada."
            ls -la blog/
          fi

      # 3. Instala Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 4. Instala dependencias
      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      # 5. Ejecuta el anÃ¡lisis de noticias
      - name: Run news analyzer
        run: |
          python script/daily_analyzer.py

      # 6. Guarda la fecha actual
      - name: Set current date
        run: echo "DATE=$(date +%Y-%m-%d)" >> $GITHUB_ENV

      # 7. Instala Hugo
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'
          extended: true

      # 8. Construye el sitio Hugo
      - name: Build Hugo site
        run: |
          cd blog
          hugo --source . --destination ../docs --verbose

      # 9. Verifica que docs/ se haya creado
      - name: Check if docs was generated
        run: |
          if [ -d "docs" ]; then
            echo "âœ… Carpeta 'docs/' creada con Ã©xito."
            find docs -type f | head -20
          else
            echo "âŒ Error: 'docs/' no se generÃ³. Revisa los errores de Hugo."
            exit 1
          fi

      # 10. Crea Pull Request con los resultados
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.PAT }}
          branch: auto-update-daily
          commit-message: "Daily update: ${{ env.DATE }}"
          title: "ğŸ“° Daily News Analysis - ${{ env.DATE }}"
          body: |
            Automated news analysis from global RSS feeds.

            - Collected and classified news using BERTopic
            - Generated topic evolution, co-occurrence, and similarity
            - Published daily report

            ğŸ“Š Results: results/daily/${{ env.DATE }}/
            ğŸ“„ Post: blog/content/posts/daily-${{ env.DATE }}.md

            _This PR is updated daily. Merge when ready._
          delete-branch: true
          add-paths: |
            docs/
            blog/content/posts/
            results/daily/
